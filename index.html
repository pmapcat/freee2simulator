<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Free Estradiol Estimator</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background-color: #f5f7fa;
        margin: 0;
        padding: 2rem;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: auto;
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        font-size: 1.8rem;
        margin-bottom: 1rem;
        text-align: center;
      }
      p {
        font-size: 0.95rem;
        line-height: 1.5;
      }
      i {
        color: #666;
      }
      table {
        width: 100%;
        margin-top: 1.5rem;
        border-spacing: 0.5rem;
      }
      td {
        padding: 0.5rem 0;
      }
      input[type="text"] {
        padding: 0.4rem;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
      }
      input[type="button"] {
        background-color: #007bff;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 1rem;
      }
      input[type="button"]:hover {
        background-color: #0056b3;
      }
      .result {
        font-weight: bold;
        font-size: 1rem;
        margin-top: 1rem;
      }
      .footer {
        text-align: center;
        margin-top: 2rem;
        font-size: 0.8rem;
        color: #888;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Free Estradiol Estimator</h1>
      <p>Note: Results may be lower if you're taking Boron or if T is a significant proportion of SHBG.</p>
      <p>
        To use, enter your E2 and T in either SI or US units, then click the button to calculate.
      </p>
      <p><i>Equations are from Vermeulen et al: <a href="https://cebp.aacrjournals.org/content/11/10/1065" target="_blank">reference</a>.</i></p>

      <table>
        <tr>
          <td>Estradiol (E2) pmol/L</td>
          <td><input id="E2SI" type="text" value="0" onchange="E2SIChange(this.value)" /></td>
          <td>pg/mL</td>
          <td><input id="E2US" type="text" value="0" onchange="E2USChange(this.value)" /></td>
        </tr>
        <tr>
          <td>Testosterone (T) nmol/L</td>
          <td><input id="TSI" type="text" value="0" onchange="TSIChange(this.value)" /></td>
          <td>ng/dL</td>
          <td><input id="TUS" type="text" value="0" onchange="TUSChange(this.value)" /></td>
        </tr>
        <tr>
          <td>SHBG nmol/L</td>
          <td colspan="3"><input id="SHBG" type="text" value="0" /></td>
        </tr>
      </table>

      <input type="button" value="Calculate Free E2" onclick="CalculateFreeE2()" />

      <div class="result">
        <p>Free E2 pmol/L: <span id="FreeE2SI"></span></p>
        <p>Free E2 pg/mL: <span id="FreeE2US"></span></p>
        <p>Free T pmol/L: <span id="FreeTSI"></span></p>
        <p>Free T ng/dL: <span id="FreeTUS"></span></p>
      </div>

      <div class="footer">
        For issues, contact <i>u/Ally-SR</i> on Reddit.
      </div>
    </div>

    <script>
      function E2SIChange(val) {
        document.getElementById("E2US").value = (val * 0.2724).toFixed(2);
      }
      function E2USChange(val) {
        document.getElementById("E2SI").value = (val / 0.2724).toFixed(2);
      }
      function TSIChange(val) {
        document.getElementById("TUS").value = (val * 28.842).toFixed(2);
      }
      function TUSChange(val) {
        document.getElementById("TSI").value = (val / 28.842).toFixed(2);
      }

      function CalculateFreeE2() {
        const E2 = parseFloat(document.getElementById("E2SI").value) * 1e-12;
        const T = parseFloat(document.getElementById("TSI").value) * 1e-9;
        const CSHBG = parseFloat(document.getElementById("SHBG").value) * 1e-9;

        const KaE2 = 4.21e4,
          Ca = 6.5e-4,
          KsE2 = 3.14e8,
          KaT = 4.06e4,
          KsT = 1.0e9,
          N2 = KaE2 * Ca + 1,
          N1 = KaT * Ca + 1;

        let fE2 = E2 / 100,
          increment = 1e-12,
          fE2diff = 1,
          lastdiff = 1;

        while (fE2diff > 1e-15) {
          const fE2p = (E2 - N2 * fE2) / (KsE2 * (CSHBG - E2 + N2 * fE2));
          lastdiff = fE2diff;
          fE2diff = Math.abs(fE2p - fE2);
          if (fE2diff > lastdiff) increment = -increment / 10;
          fE2 += increment;
        }

        let fT = T / 100,
          fTdiff = 1;
        increment = 1e-9;
        while (fTdiff > 1e-15) {
          const fTp = (T - N1 * fT) / (KsT * (CSHBG - T + N1 * fT));
          fTdiff = Math.abs(fTp - fT);
          if (fTdiff > lastdiff) increment = -increment / 10;
          fT += increment;
        }

        const AT = KaT * Ca * fT;
        const SHBGT = T - AT - fT;
        if (SHBGT > CSHBG / 20) alert("T is stealing SHBG, Free E2 may be underestimated");

        const fE2percent = ((fE2 / E2) * 100).toFixed(2),
          fTpercent = ((fT / T) * 100).toFixed(2);

        document.getElementById("FreeE2SI").innerText = (fE2 * 1e12).toFixed(2) + ` (${fE2percent}%)`;
        document.getElementById("FreeE2US").innerText = (fE2 * 1e12 * 0.2724).toFixed(2) + ` (${fE2percent}%)`;
        document.getElementById("FreeTSI").innerText = (fT * 1e12).toFixed(2) + ` (${fTpercent}%)`;
        document.getElementById("FreeTUS").innerText = (fT * 1e9 * 28.842).toFixed(2) + ` (${fTpercent}%)`;
      }
    </script>
  </body>
</html>
